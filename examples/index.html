<!DOCTYPE html>
<html>
<head>
  <!-- Meta tags that set up the page as a mobile page   -->
  <meta name = "viewport" content = "user-scalable=no, initial-scale=1.0, maximum-scale=1.0, width=device-width">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta charset="UTF-8"/>
  <title>Virtual List demo</title>
  <link rel="stylesheet" type="text/css" media="screen,print" href="style.css"/>
</head>
<body>
  <label for="latency">Latency (ms): </label><input name="latency" id="latency" type="text" value="1000"/>
  <label for="calls">Calls: </label><input readonly="readonly" name="calls" id="calls" type="text" value="0"/>
  <label for="total-calls">Total Calls: </label><input readonly="readonly" name="total-calls" id="total-calls" type="text" value="0"/>
  <input id="refresh" type="button" value="Refresh."/>
  <input id="insertStart" type="button" value="Insert at start of DB."/>
  <input id="removeStart" type="button" value="Remove from start of DB."/>
  <input id="update" type="button" value="Update DB items."/>
  <script type="text/javascript" src="../vlist.js"></script>
  <script>

   function DB() {
     var lastEditedEtag = 0;
     var store = [];
     for (var i = 0; i < 3000; i++) {
       store.push("person " + i);
     }

     this.retrievePage = function(pageIndex, callback) {
       document.getElementById('calls').value = parseInt(document.getElementById('calls').value) + 1;
       document.getElementById('total-calls').value = parseInt(document.getElementById('total-calls').value) + 1;

       var end = (pageIndex + 1) * pageSize;
       if (end > store.length) {
	 end = store.length;
       }
       requestedItems = store.slice(pageIndex * pageSize, end);

       setTimeout(function() {
	 document.getElementById('calls').value = parseInt(document.getElementById('calls').value) - 1;
	 callback(requestedItems, lastEditedEtag, store.length);
       }, document.getElementById('latency').value);
     }

     this.insertStart = function() {
       var oldStore = store;
       store = [];
       store[0] = 'NEW PERSON!!!';
       for (var i = 0; i < oldStore.length; i++) {
	 store.push(oldStore[i]);
       }
       lastEditedEtag++;
     }

     this.removeStart = function() {
       var oldStore = store;
       store = [];
       for (var i = 1; i < oldStore.length; i++) {
	 store.push(oldStore[i]);
       }
       lastEditedEtag++;
     }

     this.update = function() {
       for (var i = 0; i < store.length; i++) {
	 store[i] = store[i] + ' UPDATED!';
       }
       lastEditedEtag++;
     }
   }

   // Object to represent Owncloud server calls.
   var db = new DB();
   document.getElementById('insertStart').addEventListener('click', db.insertStart);
   document.getElementById('removeStart').addEventListener('click', db.removeStart);
   document.getElementById('update').addEventListener('click', db.update);

   // Local cache of items.
   var items = [];
   // Number of items stored on the server.
   var itemsCount = 0;

   // Last etag received from "server".
   var lastEtag;

   var pageSize = 100;
   // Determine the index of the page a particular item is on.
   function getPageIndex(itemIndex) {
       return parseInt(itemIndex / pageSize);
   }

   function retrieveItems(start, end, callback, originalStart) {
     // Set the original starting point for this call.
     if (originalStart === undefined) {
       originalStart = start;
     }
     for (var i = start; i < end; i++) {
       // Check if we have a local copy of this item.
       if (items[i] === undefined) {
	 var pageIndex = getPageIndex(i);
	 db.retrievePage(pageIndex, function(requestedItems, etag, newItemsCount) {
	   itemsCount = newItemsCount;
	   // If our etag is out of date, clear all local items.
	   if (etag != lastEtag) {
	     clearItems();
	   }

	   // Insert the newly retrieved items.
	   for (var j = 0; j < requestedItems.length; j++) {
	     items[pageIndex * pageSize + j] = requestedItems[j];
	   }

	   if (etag != lastEtag) {
	     lastEtag = etag;
	     // Restart item retrieval for this entire call, as
	     // previously retrieved items may be out of date.
	     retrieveItems(originalStart, end, callback);
	   }
	   else {
	     // Continue retrieving more items.
	     retrieveItems(i + 1, end, callback, originalStart);
	   }
	 });
	 return;
       }
     }
     callback();
   }

   function clearItems() {
     items = [];
   }

   var list = new VirtualList({
     h: window.innerHeight - 100,
     itemHeight: 30,
     generatorFn: function(item) {
       var el = document.createElement("div");
       el.innerHTML = "<p style='height: 30px;'>" + item + "</p>";
       return el;
     },
     getItems: function(offset, count, callback) {
       var end = offset + count;
       if (end > itemsCount) {
	 end = itemsCount;
       }
       retrieveItems(offset, end, function(newItemsCount) {
	 // The itemsCount may have been updated after the last server request.
	 if (end > itemsCount) {
	   end = itemsCount;
	 }
	 callback(items.slice(offset, end), itemsCount)
       });
     }
   });

   // Force items to refresh from DB.
   function refresh() {
     clearItems();
     list.refresh();
   }
   document.getElementById('refresh').addEventListener('click', refresh);

   list.container.classList.add("container");
   document.body.appendChild(list.container)
  </script>
</body>
</html>
